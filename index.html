<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Most Popular Movies</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #111; color: #fff; text-align: center; margin: 0; }
        .movies-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; padding: 20px; }
        .movie-card { background: #222; padding: 10px; border-radius: 8px; cursor: pointer; transition: transform 0.2s; }
        .movie-card:hover { transform: scale(1.05); }
        .movie-card img { width: 100%; border-radius: 8px; height: 270px; object-fit: cover; }
        .movie-title { font-size: 14px; margin-top: 8px; }
        .error-log { background: #333; padding: 10px; margin: 20px auto; width: 90%; text-align: left; border-left: 4px solid red; font-size: 14px; }
        .copy-btn { background: red; color: white; border: none; padding: 5px; margin-left: 10px; cursor: pointer; }
        .player-container { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #000; padding: 10px; border-radius: 8px; z-index: 1000; }
        .close-btn { position: absolute; top: 5px; right: 10px; background: red; border: none; color: white; padding: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ðŸŽ¬ Most Popular Movies</h1>
    <div id="movies" class="movies-container"></div>
    <div id="log-container"></div>
    
    <!-- ðŸŽ¥ Modern Video Player -->
    <div id="player" class="player-container">
        <button class="close-btn" onclick="closePlayer()">âœ–</button>
        <video id="movie-player" controls width="320" height="180"></video>
    </div>

    <script>
        const API_KEY = '97a0851af1msh8136e2298325bc7p1170d9jsn53c4b47c7bf0';
        const API_HOST = 'imdb236.p.rapidapi.com';
        const movieGrid = document.getElementById('movies');
        const logContainer = document.getElementById('log-container');
        const playerContainer = document.getElementById('player');
        const moviePlayer = document.getElementById('movie-player');

        // ðŸ“Œ Log messages (for debugging)
        function logMessage(message, isError = false) {
            const logDiv = document.createElement('div');
            logDiv.classList.add('error-log');
            logDiv.style.color = isError ? 'red' : 'white';
            logDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;

            const copyBtn = document.createElement('button');
            copyBtn.classList.add('copy-btn');
            copyBtn.textContent = 'Copy';
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(message);
                alert('Copied to clipboard!');
            };

            logDiv.appendChild(copyBtn);
            logContainer.appendChild(logDiv);
        }

        // ðŸ”„ Retry system (API requests up to 3 times)
        async function fetchWithRetry(url, options, retries = 3) {
            for (let attempt = 1; attempt <= retries; attempt++) {
                try {
                    logMessage(`Attempt ${attempt}: Fetching ${url}...`);
                    const response = await fetch(url, options);

                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);

                    const data = await response.json();
                    if (!data.data || data.data.length === 0) throw new Error('No data received from API.');

                    return data;
                } catch (error) {
                    logMessage(`Error on attempt ${attempt}: ${error.message}`, true);
                    if (attempt === retries) {
                        logMessage(`Failed after ${retries} attempts.`, true);
                        return null;
                    }
                }
            }
        }

        async function fetchMovies() {
            logMessage('Fetching popular movies...');
            
            const url = `https://imdb236.p.rapidapi.com/imdb/most-popular-movies`;
            const options = {
                headers: { 'X-RapidAPI-Key': API_KEY, 'X-RapidAPI-Host': API_HOST }
            };

            const data = await fetchWithRetry(url, options);

            if (data) {
                displayMovies(data.data);
                logMessage('Movies loaded successfully.');
            } else {
                movieGrid.innerHTML = `<p style="color:red; text-align:center;">Failed to load movies. Please try again later.</p>`;
            }
        }

        function displayMovies(movies) {
            movieGrid.innerHTML = '';

            movies.forEach(movie => {
                const poster = movie.primaryImage || 'https://via.placeholder.com/200x300?text=No+Image';
                const movieCard = document.createElement('div');
                movieCard.classList.add('movie-card');
                movieCard.innerHTML = `<img src="${poster}" alt="${movie.primaryTitle}"><div class="movie-title">${movie.primaryTitle}</div>`;
                movieCard.onclick = () => playMovie(movie);
                movieGrid.appendChild(movieCard);
            });
        }

        function playMovie(movie) {
            logMessage(`Playing movie: ${movie.primaryTitle}`);

            // If there's an external video link, play it; otherwise, show an error
            if (movie.externalLinks && movie.externalLinks.length > 0) {
                const videoURL = movie.externalLinks[0];
                moviePlayer.src = videoURL;
                moviePlayer.play();
                playerContainer.style.display = 'block';
            } else {
                logMessage(`No trailer found for ${movie.primaryTitle}`, true);
                alert(`No trailer available for "${movie.primaryTitle}".`);
            }
        }

        function closePlayer() {
            moviePlayer.pause();
            moviePlayer.src = '';
            playerContainer.style.display = 'none';
        }

        fetchMovies();
    </script>
</body>
</html>
